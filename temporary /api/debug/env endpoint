
from fastapi import APIRouter
from typing import Any, Dict
import os

debug_router = APIRouter()

def mask(value: str | None, show_last: int = 4) -> str:
    """Return a masked version of a secret/string."""
    if value is None:
        return "None"
    v = str(value)
    if len(v) <= show_last:
        return "*" * len(v)
    return "*" * (len(v) - show_last) + v[-show_last:]

def parse_float(name: str) -> Dict[str, Any]:
    """Try to parse an env var as float; report value and parse result."""
    raw = os.getenv(name)
    try:
        parsed = float(raw) if raw is not None else None
        ok = parsed is not None
        return {"name": name, "raw": raw, "parsed": parsed, "ok": ok, "type": "float"}
    except Exception as e:
        return {"name": name, "raw": raw, "parsed": None, "ok": False, "error": str(e), "type": "float"}

def present(name: str) -> Dict[str, Any]:
    """Presence check for simple strings (non-numeric)."""
    raw = os.getenv(name)
    return {"name": name, "raw": raw, "present": raw is not None, "type": "str"}

@debug_router.get("/api/debug/env")
def debug_env():
    """
    Temporary diagnostic: shows presence and parse status of all required env vars.
    Sensitive values are masked.
    """
    # Sensitive (mask)
    api_key = os.getenv("OCTOPUS_API_KEY")
    elec_mpan = os.getenv("ELEC_MPAN")
    elec_serial = os.getenv("ELEC_SERIAL")
    gas_mprn = os.getenv("GAS_MPRN")
    gas_serial = os.getenv("GAS_SERIAL")

    data = {
        "sensitive": {
            "OCTOPUS_API_KEY": mask(api_key),
            "ELEC_MPAN": mask(elec_mpan),
            "ELEC_SERIAL": mask(elec_serial),
            "GAS_MPRN": mask(gas_mprn),
            "GAS_SERIAL": mask(gas_serial),
        },
        "strings": [
            present("AGILE_PRODUCT_CODE"),
            present("AGILE_TARIFF_CODE"),
        ],
        "numbers": [
            parse_float("ELEC_STANDING_CHARGE"),
            parse_float("GAS_UNIT_RATE"),
            parse_float("GAS_STANDING_CHARGE"),
        ],
    }
    return data
